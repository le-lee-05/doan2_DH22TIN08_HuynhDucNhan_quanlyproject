generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============== USER & AUTH ==============

model User {
  id            String       @id @default(cuid())
  email         String       @unique
  password      String?
  name          String
  avatar        String?
  provider      AuthProvider @default(LOCAL)
  providerId    String?
  theme         Theme        @default(SYSTEM)
  emailVerified Boolean      @default(false)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  memberships   WorkspaceMember[]
  assignedTasks TaskAssignee[]
  comments      Comment[]
  notifications Notification[]
}

// ============== WORKSPACE (Multi-tenant) ==============

model Workspace {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  logo      String?
  plan      Plan     @default(FREE)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members     WorkspaceMember[]
  projects    Project[]
  invitations WorkspaceInvitation[]
}

model WorkspaceMember {
  id          String   @id @default(cuid())
  userId      String
  workspaceId String
  role        Role     @default(MEMBER)
  joinedAt    DateTime @default(now())

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([userId, workspaceId])
}

model WorkspaceInvitation {
  id          String   @id @default(cuid())
  workspaceId String
  email       String
  role        Role     @default(MEMBER)
  token       String   @unique
  expiresAt   DateTime
  createdAt   DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, email])
}

// ============== PROJECT ==============

model Project {
  id          String        @id @default(cuid())
  workspaceId String
  name        String
  description String?
  color       String        @default("#6366f1")
  icon        String?
  status      ProjectStatus @default(ACTIVE)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  tasks     Task[]
}

// ============== TASK (2 levels: Task + Subtask) ==============

model Task {
  id          String     @id @default(cuid())
  projectId   String
  parentId    String?
  title       String
  description String?
  status      TaskStatus @default(TODO)
  priority    Priority   @default(MEDIUM)
  position    Int        @default(0)
  dueDate     DateTime?
  completedAt DateTime?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  project     Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  parent      Task?           @relation("Subtasks", fields: [parentId], references: [id], onDelete: Cascade)
  subtasks    Task[]          @relation("Subtasks")
  assignees   TaskAssignee[]
  comments    Comment[]
  checklists  ChecklistItem[]
  attachments Attachment[]
}

model TaskAssignee {
  taskId     String
  userId     String
  assignedAt DateTime @default(now())

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([taskId, userId])
}

model ChecklistItem {
  id        String  @id @default(cuid())
  taskId    String
  title     String
  completed Boolean @default(false)
  position  Int     @default(0)

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
}

model Attachment {
  id        String   @id @default(cuid())
  taskId    String
  filename  String
  path      String
  mimetype  String
  size      Int
  createdAt DateTime @default(now())

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
}

// ============== COMMENTS ==============

model Comment {
  id        String   @id @default(cuid())
  taskId    String
  userId    String
  content   String
  mentions  String[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ============== NOTIFICATIONS ==============

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  data      Json?
  read      Boolean          @default(false)
  createdAt DateTime         @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ============== ENUMS ==============

enum AuthProvider {
  LOCAL
  GOOGLE
}

enum Role {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

enum Plan {
  FREE
  STARTER
  PROFESSIONAL
}

enum ProjectStatus {
  ACTIVE
  COMPLETED
  ARCHIVED
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DONE
}

enum Priority {
  URGENT
  HIGH
  MEDIUM
  LOW
}

enum NotificationType {
  TASK_ASSIGNED
  TASK_UPDATED
  TASK_COMPLETED
  COMMENT_ADDED
  COMMENT_MENTION
  DEADLINE_APPROACHING
  INVITATION_RECEIVED
}

enum Theme {
  LIGHT
  DARK
  SYSTEM
}
